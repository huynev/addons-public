<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="delivery_display.DeliveryDisplay">
        <div class="o_delivery_display d-flex flex-column h-100" t-ref="root">
            <div class="d-flex flex-grow-1 overflow-hidden">
                <!-- Drivers Panel -->
                <DeliveryDisplayDriversPanel
                    drivers="state.drivers"
                    setSessionDriver.bind="setSessionDriver"
                    popupAddDriver.bind="popupAddDriver"
                    logout.bind="logout"/>

                <!-- Main Content -->
                <div class="flex-grow-1 d-flex flex-column overflow-hidden">
                    <!-- Simple Header -->
                    <div class="border-bottom p-3 bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fa fa-truck me-2"/>
                                Deliveries
                                <span class="badge bg-primary ms-2" t-esc="state.deliveries.length"/>
                            </h5>
                            <div t-if="state.drivers.selected">
                                <span class="badge bg-info">
                                    <i class="fa fa-filter me-1"/>
                                    Filtered by: <t t-esc="state.drivers.connected.find(d => d.id === state.drivers.selected)?.name || 'Unknown'"/>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Deliveries List -->
                    <div class="o_delivery_list flex-grow-1 overflow-auto p-3">
                        <div class="row g-3">
                            <t t-foreach="state.deliveries" t-as="delivery" t-key="delivery.resId">
                                <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                                    <div class="card h-100 shadow-sm delivery-card"
                                         t-att-data-delivery-id="delivery.resId"
                                         t-att-class="delivery.data.driver_id ? 'has-driver' : 'no-driver'"
                                         t-on-click="() => this.onDeliveryCardClick(delivery)"
                                         t-att-title="delivery.data.driver_id ? 'Click to validate delivery' : 'Click to assign driver and validate'"
                                         style="cursor: pointer;">
                                        <div class="card-header d-flex justify-content-between align-items-center"
                                             t-attf-class="bg-{{getDeliveryStateColor(delivery.data.state)}} text-white">
                                            <span class="fw-bold" t-esc="delivery.data.name"/>
                                            <i class="fa" t-att-class="getPriorityIcon(delivery.data.priority)"/>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-2">
                                                <i class="fa fa-user me-2 text-muted"/>
                                                <span t-esc="delivery.data.partner_id ? delivery.data.partner_id[1] : 'N/A'"/>
                                            </div>
                                            <div class="mb-2" t-if="delivery.data.scheduled_date">
                                                <i class="fa fa-calendar me-2 text-muted"/>
                                                <span t-esc="formatDate(delivery.data.scheduled_date)"/>
                                            </div>
                                            <div class="mb-2" t-if="delivery.data.driver_id">
                                                <i class="fa fa-id-card me-2 text-success"/>
                                                <strong class="text-success" t-esc="'âœ“ ' + delivery.data.driver_id[1]"/>
                                            </div>
                                            <div class="mb-2" t-if="!delivery.data.driver_id">
                                                <i class="fa fa-id-card me-2 text-muted"/>
                                                <span class="text-muted">No driver assigned</span>
                                            </div>
                                            <div class="mb-2" t-if="delivery.data.origin">
                                                <i class="fa fa-file me-2 text-muted"/>
                                                <span class="text-muted small" t-esc="delivery.data.origin"/>
                                            </div>
                                        </div>
                                        <div class="card-footer d-flex justify-content-between align-items-center">
                                            <span class="badge"
                                                  t-attf-class="bg-{{getDeliveryStateColor(delivery.data.state)}}"
                                                  t-esc="delivery.data.state.toUpperCase()"/>
                                            <small t-if="delivery.data.driver_id" class="text-success">
                                                <i class="fa fa-mouse-pointer me-1"/>Click to validate
                                            </small>
                                            <small t-if="!delivery.data.driver_id" class="text-muted">
                                                <i class="fa fa-hand-pointer-o me-1"/>Click to assign
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </t>
                            <t t-if="!state.filteredDeliveries?.length and !state.deliveries.length">
                                <div class="col-12">
                                    <div class="alert alert-info text-center">
                                        <i class="fa fa-info-circle fa-3x mb-3"/>
                                        <h5>No deliveries found</h5>
                                        <p>There are no deliveries matching your current filters.</p>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assign Driver Dialog -->
            <t t-if="state.showAssignDialog">
                <div class="modal fade show d-block"
                     t-att-class="{'modal-closing': state.assignDialogData.isClosing}"
                     tabindex="-1"
                     style="background-color: rgba(0,0,0,0.5);">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fa fa-id-badge me-2"/>
                                    <t t-if="state.assignDialogData.mode === 'driver_login'">Driver Login</t>
                                    <t t-elif="state.assignDialogData.mode === 'validate_existing'">Validate Delivery</t>
                                    <t t-else="">Assign Driver &amp; Validate</t>
                                </h5>
                                <button type="button" class="btn-close btn-close-white" t-on-click="closeAssignDialog"/>
                            </div>
                            <div class="modal-body">
                                <!-- Driver Login Mode -->
                                <div t-if="state.assignDialogData.mode === 'driver_login'" class="alert alert-info mb-4">
                                    <h6 class="mb-2">
                                        <i class="fa fa-user me-2"/>Login as: <strong t-esc="state.assignDialogData.driverToLogin?.name"/>
                                    </h6>
                                    <small class="text-muted">Enter your PIN or scan your badge to login</small>
                                </div>

                                <!-- Delivery Info (for validation modes) -->
                                <div t-if="state.assignDialogData.delivery" class="alert alert-info mb-4">
                                    <div class="mb-1">
                                        <strong>Delivery:</strong>
                                        <span class="ms-2 badge bg-info" t-esc="state.assignDialogData.delivery?.data.name"/>
                                    </div>
                                    <div class="mb-1">
                                        <strong>Customer:</strong>
                                        <span class="ms-2" t-esc="state.assignDialogData.delivery?.data.partner_id ? state.assignDialogData.delivery.data.partner_id[1] : 'N/A'"/>
                                    </div>
                                    <div t-if="state.assignDialogData.delivery?.data.scheduled_date">
                                        <strong>Scheduled:</strong>
                                        <span class="ms-2" t-esc="formatDate(state.assignDialogData.delivery.data.scheduled_date)"/>
                                    </div>
                                </div>

                                <!-- Instructions -->
                                <div class="mb-3 text-center">
                                    <i class="fa fa-barcode fa-3x text-primary mb-2"/>
                                    <p class="mb-1">
                                        <strong>Enter your PIN or scan your barcode</strong>
                                    </p>
                                    <small class="text-muted">
                                        <t t-if="state.assignDialogData.mode === 'driver_login'">
                                            Login to access your deliveries
                                        </t>
                                        <t t-elif="state.assignDialogData.mode === 'validate_existing'">
                                            Authenticate to validate this delivery
                                        </t>
                                        <t t-else="">
                                            The delivery will be assigned to you and validated immediately
                                        </t>
                                    </small>
                                </div>

                                <!-- PIN/Barcode Input -->
                                <div class="mb-3">
                                    <label for="pin_barcode_input" class="form-label">
                                        <i class="fa fa-key me-1"/>
                                        PIN or Barcode
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <input
                                            type="text"
                                            class="form-control text-center"
                                            id="pin_barcode_input"
                                            placeholder="Enter PIN or scan barcode..."
                                            t-att-value="state.assignDialogData.pinOrBarcode"
                                            t-on-input="updatePinOrBarcode"
                                            t-on-keyup="onPinInputKeyup"
                                            autofocus="autofocus"/>
                                        <button class="btn btn-outline-primary"
                                                type="button"
                                                t-on-click="openCameraScanner"
                                                title="Scan with camera">
                                            <i class="fa fa-camera fa-lg"/>
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fa fa-info-circle me-1"/>
                                        Click camera button to scan barcode with your device camera
                                    </small>
                                </div>

                                <div t-if="state.assignDialogData.mode !== 'driver_login'" class="alert alert-warning mb-0">
                                    <i class="fa fa-exclamation-triangle me-2"/>
                                    <small>Make sure your PIN or barcode is correct. The delivery will be validated after authentication.</small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" t-on-click="closeAssignDialog">
                                    <i class="fa fa-times me-1"/>
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-primary btn-lg"
                                        t-on-click="confirmAssignDriver"
                                        t-att-disabled="!state.assignDialogData.pinOrBarcode">
                                    <i class="fa fa-check me-2"/>
                                    <t t-if="state.assignDialogData.mode === 'driver_login'">Login</t>
                                    <t t-elif="state.assignDialogData.mode === 'validate_existing'">Validate</t>
                                    <t t-else="">Confirm &amp; Validate</t>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </t>

            <!-- Camera Scanner Modal -->
            <t t-if="state.showCameraScanner">
                <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.8);">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-dark text-white">
                                <h5 class="modal-title">
                                    <i class="fa fa-camera me-2"/>
                                    Scan Barcode with Camera
                                </h5>
                                <button type="button" class="btn-close btn-close-white" t-on-click="closeCameraScanner"/>
                            </div>
                            <div class="modal-body bg-dark p-0">
                                <!-- Camera Video -->
                                <div class="position-relative" style="background: black;">
                                    <video
                                        t-ref="video_scanner"
                                        class="w-100"
                                        style="max-height: 500px; object-fit: contain;"
                                        autoplay="autoplay"
                                        playsinline="playsinline">
                                    </video>

                                    <!-- Scanning Overlay -->
                                    <div class="position-absolute top-50 start-50 translate-middle"
                                         style="width: 80%; height: 200px; border: 3px solid #00ff00; border-radius: 10px; pointer-events: none;">
                                        <div class="position-absolute top-50 start-50 translate-middle text-white bg-dark bg-opacity-75 px-3 py-2 rounded">
                                            <i class="fa fa-crosshairs fa-2x"/>
                                        </div>
                                    </div>

                                    <!-- Scanning Status -->
                                    <div class="position-absolute bottom-0 start-0 end-0 p-3 text-center">
                                        <div class="bg-dark bg-opacity-75 text-white p-3 rounded d-inline-block">
                                            <t t-if="state.isScanning">
                                                <i class="fa fa-spinner fa-spin me-2"/>
                                                <span>Scanning... Point camera at barcode</span>
                                            </t>
                                            <t t-else="">
                                                <i class="fa fa-info-circle me-2"/>
                                                <span>Starting camera...</span>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer bg-dark text-white">
                                <small class="text-muted me-auto">
                                    <i class="fa fa-lightbulb me-1"/>
                                    Tip: Ensure good lighting and hold steady
                                </small>
                                <button type="button" class="btn btn-secondary" t-on-click="closeCameraScanner">
                                    <i class="fa fa-times me-1"/>
                                    Close Camera
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </div>
    </t>
</templates>