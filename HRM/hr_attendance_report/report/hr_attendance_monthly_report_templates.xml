<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="hr_attendance_monthly_report_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <style>
                        .attendance-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 7px;
                            margin-top: 10px;
                        }
                        .attendance-table th, .attendance-table td {
                            border: 1px solid #000;
                            padding: 2px;
                            text-align: center;
                            vertical-align: middle;
                        }
                        .header-cell {
                            background-color: #f0f0f0;
                            font-weight: bold;
                            font-size: 8px;
                        }
                        .no-data {
                            background-color: #ffeeee;
                            color: #999;
                        }
                        .weekend {
                            background-color: #e6f3ff;
                        }
                        .title {
                            font-size: 18px;
                            font-weight: bold;
                            text-align: center;
                            margin-bottom: 15px;
                            color: #2c3e50;
                        }
                        .subtitle {
                            font-size: 14px;
                            text-align: center;
                            margin-bottom: 10px;
                            color: #34495e;
                        }
                        .info-table {
                            width: 100%;
                            margin-bottom: 15px;
                        }
                        .info-table td {
                            border: none;
                            padding: 3px 10px;
                            font-size: 10px;
                        }
                        .employee-name {
                            text-align: left !important;
                            font-weight: 500;
                        }
                        .summary-section {
                            margin-top: 20px;
                            padding: 10px;
                            background-color: #f8f9fa;
                            border: 1px solid #dee2e6;
                        }
                    </style>

                    <!-- Header -->
                    <div class="title">BẢNG CHẤM CÔNG GIỜ</div>
                    <div class="subtitle"><t t-esc="company_name"/></div>

                    <!-- Info table -->
                    <table class="info-table">
                        <tr>
                            <td><strong>Tháng:</strong> <t t-esc="month_name"/></td>
                            <td><strong>Năm:</strong> <t t-esc="year"/></td>
                            <td><strong>Ngày tạo:</strong> <t t-esc="report_date"/></td>
                        </tr>
                        <tr>
                            <td><strong>Người tạo:</strong> <t t-esc="user_name"/></td>
                            <td><strong>Số nhân viên:</strong> <t t-esc="len(employees)"/></td>
                            <td><strong>Bộ lọc:</strong> <t t-esc="dict(doc._fields['filter_type'].selection)[filter_type]"/></td>
                        </tr>
                    </table>

                    <!-- Attendance Table -->
                    <table class="attendance-table">
                        <!-- Header Rows -->
                        <thead>
                            <!-- Day Numbers -->
                            <tr>
                                <th rowspan="3" class="header-cell">STT</th>
                                <th rowspan="3" class="header-cell">Mã NV</th>
                                <th rowspan="3" class="header-cell">Tên nhân viên</th>
                                <th rowspan="3" class="header-cell">Phòng ban</th>
                                <th rowspan="3" class="header-cell">Chức vụ</th>
                                <t t-foreach="range(1, days_in_month + 1)" t-as="day">
                                    <th class="header-cell" colspan="2"><t t-esc="day"/></th>
                                </t>
                            </tr>

                            <!-- Day Names -->
                            <tr>
                                <t t-foreach="range(1, days_in_month + 1)" t-as="day">
                                    <t t-set="day_name" t-value="doc._get_day_name(year, int(month), day)"/>
                                    <th class="header-cell" colspan="2"><t t-esc="day_name"/></th>
                                </t>
                            </tr>

                            <!-- In/Out -->
                            <tr>
                                <t t-foreach="range(1, days_in_month + 1)" t-as="day">
                                    <th class="header-cell">Vào</th>
                                    <th class="header-cell">Ra</th>
                                </t>
                            </tr>
                        </thead>

                        <!-- Employee Data -->
                        <tbody>
                            <t t-foreach="employees" t-as="employee">
                                <tr>
                                    <td><t t-esc="employee_index + 1"/></td>
                                    <td><t t-esc="employee['employee_code']"/></td>
                                    <td class="employee-name"><t t-esc="employee['name']"/></td>
                                    <td><t t-esc="employee['department']"/></td>
                                    <td><t t-esc="employee['job_title']"/></td>

                                    <t t-foreach="range(1, days_in_month + 1)" t-as="day">
                                        <t t-set="day_data" t-value="attendance_data.get(employee['id'], {}).get(day, {})"/>
                                        <t t-set="has_data" t-value="day_data.get('has_data', False)"/>

                                        <td t-attf-class="#{'' if has_data else 'no-data'}">
                                            <t t-esc="day_data.get('check_in', '')"/>
                                        </td>
                                        <td t-attf-class="#{'' if has_data else 'no-data'}">
                                            <t t-esc="day_data.get('check_out', '')"/>
                                        </td>
                                    </t>
                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <!-- Summary Section -->
                    <t t-if="show_summary and statistics">
                        <div class="summary-section">
                            <h3>Tổng kết</h3>
                            <table style="width: 100%; font-size: 10px;">
                                <tr>
                                    <td><strong>Tổng số nhân viên:</strong> <t t-esc="statistics['total_employees']"/></td>
                                    <td><strong>Tổng ngày làm việc:</strong> <t t-esc="statistics['total_working_days']"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Tổng giờ làm việc:</strong> <t t-esc="statistics['total_working_hours']"/> giờ</td>
                                    <td><strong>Tỷ lệ chấm công:</strong> <t t-esc="statistics['overall_attendance_rate']"/>%</td>
                                </tr>
                            </table>
                        </div>
                    </t>

                    <!-- Footer -->
                    <div style="margin-top: 20px; font-size: 9px; color: #666;">
                        <p><strong>Ghi chú:</strong></p>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>Ô màu hồng: Không có dữ liệu chấm công</li>
                            <li>Thời gian trống: Chưa check-out hoặc không đầy đủ</li>
                            <li>Dữ liệu được xử lý theo timezone: <t t-esc="doc._get_user_timezone().zone"/></li>
                        </ul>
                    </div>
                </div>
            </t>
        </t>
    </template>
</odoo>